# Based off https://github.com/rapidsai/cudf/blob/branch-25.04/.github/workflows/pandas-tests.yaml
name: Test dask-upstream

on:
  schedule:
    # 06:15 and 08:15 UTC daily.
    # We want at least one one run after the nightly pipeline finishes.
    # https://github.com/rapidsai/workflows/blob/main/.github/workflows/nightly-pipeline-trigger.yaml is
    # currently set to 5:00 UTC and takes ~12 hours
    - cron: "15 06,18 * * *"
  workflow_dispatch:
    inputs:
      dask_branch:
        type: string
        description: Dask version, which will be checked out from the given branch. Default is main. Can be a tag like '2025.4.1'.
        default: main

env:
  DASK_BRANCH: ${{ inputs.dask_branch }}
  UV_LINK_MODE: "copy"  # avoid warnings in CI

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.date.outputs.date }}
      branch: ${{ steps.branch.outputs.branch }}
    steps:
      - name: Get current date
        id: date
        run: echo "name=date::$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
      - name: Get current branch
        id: branch
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> "$GITHUB_OUTPUT"

  dask-tests:
    needs: setup
    # run the Dask and Distributed unit tests
    secrets: inherit
    uses: rapidsai/shared-workflows/.github/workflows/wheels-test.yaml@branch-25.06
    with:
      # This selects "ARCH=amd64 + the latest supported Python + CUDA".
      matrix_filter: map(select(.ARCH == "amd64")) | group_by(.CUDA_VER|split(".")|map(tonumber)|.[0]) | map(max_by([(.PY_VER|split(".")|map(tonumber)), (.CUDA_VER|split(".")|map(tonumber))]))
      build_type: nightly
      branch: ${{ needs.setup.outputs.branch }}
      date: ${{ needs.setup.outputs.date }}
      sha: ${{ github.sha }}
      script: scripts/run.sh
